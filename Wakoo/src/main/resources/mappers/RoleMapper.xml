<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="wakoo.fun.mapper.RoleMapper">
    <update id="updMess">
        UPDATE sys_role SET rid=#{role.rid},role_name=#{role.roleName},status=#{role.status},update_time=NOW()
        WHERE id=#{role.id}
    </update>
    <update id="updMessRole">
        <foreach collection="role" item="item" index="index" separator=";">
            UPDATE sys_permission
            SET status = #{item.status}
            WHERE menu_id = #{item.menuId}
        </foreach>
    </update>
    <update id="updStatusRole">
        UPDATE sys_role
        <set>
            <if test="status==1">status=0</if>
            <if test="status==0">status=1</if>
        </set>
        WHERE id=#{id}
    </update>

    <select id="getAllRole" resultType="wakoo.fun.pojo.Role">
        SELECT id,rid,role_code,role_name,description,status,create_time,update_time
        FROM sys_role
        WHERE role_code LIKE CONCAT('%', #{keyword}, '%') OR
            role_name LIKE CONCAT('%', #{keyword}, '%') OR
            description LIKE CONCAT('%', #{keyword}, '%') OR
            create_time LIKE CONCAT('%', #{keyword}, '%') OR
            update_time LIKE CONCAT('%', #{keyword}, '%')
    </select>
    <select id="getButton" resultType="wakoo.fun.pojo.ButtonPermissions">
        SELECT id,path,component,name label,meta,type,p_id,hidden,redirect,cache,icon,url,sort,level,enabled,create_time,update_time FROM sys_menu WHERE id IN (SELECT menu_id FROM sys_permission WHERE role_id IN (
            SELECT role_id FROM sys_user_role))order by sys_menu.sort
    </select>
    <select id="updGetAllPermissions" resultType="wakoo.fun.pojo.ButtonPermissions">
        SELECT id,path,component,
               name label,meta,type,p_id,hidden,redirect,
               cache,icon,url,sort,level,enabled,create_time,
               update_time FROM sys_menu
    </select>
    <select id="getRoleNum" resultType="java.lang.Integer">
        SELECT COUNT(id) FROM sys_user_role WHERE role_id=#{id}
    </select>
    <select id="getByIdRoleName" resultType="java.lang.Integer">
        SELECT id FROM sys_role WHERE id=(SELECT rid FROM sys_role WHERE id=#{roleId})
    </select>
    <select id="getTwoRoleName" resultType="wakoo.fun.dto.RoleIdRoleName">
        SELECT role_name,status FROM sys_role WHERE id=#{roleId}
    </select>
    <select id="getButtonById" resultType="java.lang.Integer">
        SELECT id FROM sys_menu WHERE id IN (SELECT menu_id FROM sys_permission WHERE role_id IN (
            SELECT role_id FROM sys_user_role))order by sys_menu.sort
    </select>
    <select id="getOneByid" resultType="java.lang.Integer">
        SELECT id FROM sys_menu WHERE id IN (SELECT menu_id FROM sys_permission WHERE role_id IN (
            SELECT role_id FROM sys_user_role)) AND enabled=1 AND type=0 order by sys_menu.sort
    </select>

    <insert id="addRole" parameterType="wakoo.fun.dto.RoleButtonDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_role(rid,role_name,status,create_time)
        VALUES(#{role.fId},#{role.name},#{role.status},NOW())
    </insert>

    <insert id="addPermission">
        INSERT INTO sys_permission (role_id, menu_id,create_time) VALUES
        <foreach collection="roleVos" item="item" separator=",">
            (#{id}, #{item.id},NOW())
        </foreach>
    </insert>
</mapper>